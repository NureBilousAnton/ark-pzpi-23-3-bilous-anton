                    –ú–Ü–ù–Ü–°–¢–ï–†–°–¢–í–û –û–°–í–Ü–¢–ò –Ü –ù–ê–£–ö–ò –£–ö–†–ê–á–ù–ò
   –•–ê–†–ö–Ü–í–°–¨–ö–ò–ô –ù–ê–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢ –†–ê–î–Ü–û–ï–õ–ï–ö–¢–†–û–ù–Ü–ö–ò



                           –ö–∞—Ñ–µ–¥—Ä–∞ –ü—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó




                                        –ó–≤—ñ—Ç
                             –∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ3
                     –∑ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏: ¬´–ê–Ω–∞–ª—ñ–∑ —Ç–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥—É¬ª
–∑ —Ç–µ–º–∏: ¬´–†–æ–∑—Ä–æ–±–∫–∞ –±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏
                                     —Å–∏—Å—Ç–µ–º–∏¬ª




–í–∏–∫–æ–Ω–∞–≤:                                                               –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤:
—Å—Ç. –≥—Ä. –ü–ó–ü–Ü-23-3                                                 —Å—Ç. –≤–∏–∫–ª. –∫–∞—Ñ. –ü–Ü
–ë—ñ–ª–æ—É—Å –ê. –ê.                                                        –°–æ–∫–æ—Ä—á—É–∫ –Ü. –ü.




                                   –•–∞—Ä–∫—ñ–≤ ‚Äì 2025
                                                                            2
    3 –†–û–ó–†–û–ë–ö–ê –ë–Ü–ó–ù–ï–° –õ–û–ì–Ü–ö–ò –¢–ê –§–£–ù–ö–¶–Ü–ô –ê–î–ú–Ü–ù–Ü–°–¢–†–£–í–ê–ù–ù–Ø
                     –°–ï–†–í–ï–†–ù–û–á –ß–ê–°–¢–ò–ù–ò –°–ò–°–¢–ï–ú–ò
     3.1 –ó–∞–≤–¥–∞–Ω–Ω—è

     –û–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ –ø—Ä–æ—Ü–µ—Å–æ–º —Ä–æ–∑—Ä–æ–±–∫–∏ –±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è
—Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏. –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ñ –Ω–∞–≤–∏—á–∫–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
–±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏, —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è UML-–¥—ñ–∞–≥—Ä–∞–º –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ —Ç–∞
–≤–∑–∞—î–º–æ–¥—ñ—ó, –∞ —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è) —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏.
                                                                               3
                    –ú–Ü–ù–Ü–°–¢–ï–†–°–¢–í–û –û–°–í–Ü–¢–ò –Ü –ù–ê–£–ö–ò –£–ö–†–ê–á–ù–ò
   –•–ê–†–ö–Ü–í–°–¨–ö–ò–ô –ù–ê–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô –£–ù–Ü–í–ï–†–°–ò–¢–ï–¢ –†–ê–î–Ü–û–ï–õ–ï–ö–¢–†–û–ù–Ü–ö–ò



                          –ö–∞—Ñ–µ–¥—Ä–∞ –ü—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó




                                       –ó–≤—ñ—Ç
                            –∑ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ ‚Ññ3
                      –∑ –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∏: ¬´–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó —Ä–æ–∑—Ä–æ–±–∫–∏ –ü–ó¬ª
–∑ —Ç–µ–º–∏: ¬´–†–æ–∑—Ä–æ–±–∫–∞ –±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏
                                    —Å–∏—Å—Ç–µ–º–∏¬ª




–í–∏–∫–æ–Ω–∞–≤:                                                               –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤:
—Å—Ç. –≥—Ä. –ü–ó–ü–Ü-23-X                                                         –¥–æ—Ü–µ–Ω—Ç
–ü—Ä—ñ–∑–≤–∏—â–µ –Ü. –ü.                                                 –ü—Ä—ñ–∑–≤–∏—â–µ –í–∏–∫–ª–∞–¥–∞—á–∞
–í–∞—Ä—ñ–∞–Ω—Ç: ‚Ññ16




                                  –•–∞—Ä–∫—ñ–≤ ‚Äì 2025
                                                                                 4
    3 –†–û–ó–†–û–ë–ö–ê –ë–Ü–ó–ù–ï–° –õ–û–ì–Ü–ö–ò –¢–ê –§–£–ù–ö–¶–Ü–ô –ê–î–ú–Ü–ù–Ü–°–¢–†–£–í–ê–ù–ù–Ø
                        –°–ï–†–í–ï–†–ù–û–á –ß–ê–°–¢–ò–ù–ò –°–ò–°–¢–ï–ú–ò
     3.1 –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏

     –û–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ –ø—Ä–æ—Ü–µ—Å–æ–º —Ä–æ–∑—Ä–æ–±–∫–∏ –±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è
—Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏. –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ñ –Ω–∞–≤–∏—á–∫–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
–±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏, —Ñ—É–Ω–∫—Ü—ñ–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è UML-–¥—ñ–∞–≥—Ä–∞–º –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ —Ç–∞
–≤–∑–∞—î–º–æ–¥—ñ—ó, –∞ —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è) —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏.

     3.2 –•—ñ–¥ —Ä–æ–±–æ—Ç–∏
     3.2.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

     –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ –±–∞–∑—ñ –ø–∞—Ç–µ—Ä–Ω—É ¬´Vertical Slice¬ª
–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º–∏ —Ç–∏–ø—ñ–≤ Rust –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç—ñ
–¥–∞–Ω–∏—Ö. –û–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—É –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—É–ø–Ω—ñ –µ—Ç–∞–ø–∏:
     –∞)    –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è —Ç–∞ –í–∞–ª—ñ–¥–∞—Ü—ñ—è (Extractors): –ü–µ—Ä–µ–¥ —Ç–∏–º —è–∫ –∑–∞–ø–∏—Ç –ø–æ—Ç—Ä–∞–ø–ª—è—î –¥–æ
           –æ–±—Ä–æ–±–Ω–∏–∫–∞ (handler), —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ Axum –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏—Ç—è–≥—É—î –¥–∞–Ω—ñ.
           1)   ¬´Authenticated¬ª: –ü–µ—Ä–µ–≤—ñ—Ä—è—î JWT —Ç–æ–∫–µ–Ω, —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É—î ¬´Claims¬ª —Ç–∞
                —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞;
           2)   ¬´Validated<T>¬ª: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É ¬´garde¬ª –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                –≤—Ö—ñ–¥–Ω–æ–≥–æ JSON –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –ø—Ä–∞–≤–∏–ª–∞–º (–¥–æ–≤–∂–∏–Ω–∞ —Ä—è–¥–∫—ñ–≤, –¥—ñ–∞–ø–∞–∑–æ–Ω–∏
                –∑–Ω–∞—á–µ–Ω—å). –Ø–∫—â–æ –¥–∞–Ω—ñ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ, –∑–∞–ø–∏—Ç –≤—ñ–¥—Ö–∏–ª—è—î—Ç—å—Å—è –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 422,
                —â–µ –¥–æ –ø–æ—á–∞—Ç–∫—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏.
     –±)    –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É (Authorization): –í—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ö–µ–Ω–¥–ª–µ—Ä–∞ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è
           –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (¬´Role¬ª) —Ç–∞
           –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è –¥–æ —Ä–µ—Å—É—Ä—Å—É (–≤–ª–∞—Å–Ω–∏–∫, –ø—ñ–¥–ª–µ–≥–ª–∏–π, –ø—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø).
     –≤)    –í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ—ó: –í–∏–∫–ª–∏–∫ –º–µ—Ç–æ–¥—ñ–≤ –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–∏—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥,
           ¬´Profile::update¬ª), —è–∫—ñ –≤–∑–∞—î–º–æ–¥—ñ—é—Ç—å –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö.
      –≥)   –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫: –í—Å—ñ –ø–æ–º–∏–ª–∫–∏, —â–æ –≤–∏–Ω–∏–∫–∞—é—Ç—å (–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–ø–∏—Å—É,
           –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ–º–µ–Ω, –ø–æ–º–∏–ª–∫–∏ –ë–î), –∫–æ–Ω–≤–µ—Ä—Ç—É—é—Ç—å—Å—è –≤ —É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–ª—ñ–∫
           ¬´Error¬ª, –∫–æ—Ç—Ä–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—É HTTP
           –≤—ñ–¥–ø–æ–≤—ñ–¥—å.
                                                                                                    5
      3.2.2 –ê–ª–≥–æ—Ä–∏—Ç–º–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ (–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å)

      –Ø–¥—Ä–æ–º –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ —Å–∏—Å—Ç–µ–º–∏ —î –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è,
—è–∫–∏–π –º–æ–¥–µ–ª—é—î –ø—Ä–∏—Ä–æ–¥–Ω—É –∑–º—ñ–Ω—É —Å–ø–µ–∫—Ç—Ä–∞ —Å–æ–Ω—è—á–Ω–æ–≥–æ —Å–≤—ñ—Ç–ª–∞ –ø—Ä–æ—Ç—è–≥–æ–º –¥–æ–±–∏. –§—É–Ω–∫—Ü—ñ—è
ùëá (ùë°), —â–æ –≤–∏–∑–Ω–∞—á–∞—î –∫–æ–ª—ñ—Ä–Ω—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É (—É –ö–µ–ª—å–≤—ñ–Ω–∞—Ö) –≤ –º–æ–º–µ–Ω—Ç —á–∞—Å—É ùë°, —î
—Ñ—É–Ω–∫—Ü—ñ—î—é, —è–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö (—Å—Ö—ñ–¥/–∑–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è) —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—Ä–æ–∑–∫–ª–∞–¥ —Å–Ω—É).
      –í—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∞–ª–≥–æ—Ä–∏—Ç–º—É:
      ‚Äì     ùë°cur ‚Äì –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å (—É —Ö–≤–∏–ª–∏–Ω–∞—Ö –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ–±–∏);
      ‚Äì     ùë°wake ‚Äì —á–∞—Å –ø—Ä–æ–±—É–¥–∂–µ–Ω–Ω—è (–∫—ñ–Ω–µ—Ü—å —Å–Ω—É);
      ‚Äì     ùë°sleep ‚Äì —á–∞—Å –≤—ñ–¥—Ö–æ–¥—É –¥–æ —Å–Ω—É;
      ‚Äì     ùë°sunset ‚Äì —á–∞—Å –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è (—Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–æ—é ¬´sunrise¬ª –Ω–∞ –æ—Å–Ω–æ–≤—ñ
            —à–∏—Ä–æ—Ç–∏ ùúë —Ç–∞ –¥–æ–≤–≥–æ—Ç–∏ ùúÜ);
      ‚Äì     ùêæmin , ùêæmax ‚Äì –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫–æ–ª—ñ—Ä–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥,
            2000K —Ç–∞ 6500K).
      –î–ª—è      –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è       –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ           –ø–µ—Ä–µ—Ö–æ–¥—É        –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è     –ø—Ä–æ–º—ñ–∂–Ω–∞
¬´—Ä–µ–ª–∞–∫—Å–∞—Ü—ñ–π–Ω–∞¬ª —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ùêærelax , —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É –≤–µ—á—ñ—Ä–Ω—ñ–π —á–∞—Å:
                                         1
                          ùêæùëüùëíùëôùëéùë• = ùêæùëöùëñùëõ + (ùêæùëöùëéùë• ‚àí ùêæùëöùëñùëõ )                                       (3.1)
                                         3
      –î–ª—è –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤ –º—ñ–∂ —Ñ–∞–∑–∞–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π
—á–∞—Å ùúè ‚àà [0, 1], —â–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è —è–∫:
                                                          ùë° ‚àí ùë°ùë†ùë°ùëéùëüùë°
                              ùúè (ùë°, ùë°ùë†ùë°ùëéùëüùë° , ùë°ùëíùëõùëë ) =                                          (3.2)
                                                        ùë°ùëíùëõùëë ‚àí ùë°ùë†ùë°ùëéùëüùë°
      –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–∑–¥—ñ–ª—è—î –¥–æ–±—É –Ω–∞ —á–æ—Ç–∏—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–∑–∏, –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑ —è–∫–∏—Ö
–∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –æ–∫—Ä–µ–º–∏–π –∑–∞–∫–æ–Ω –∑–º—ñ–Ω–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏:
      –∞)    –§–∞–∑–∞ ¬´–†–∞–Ω–∫–æ–≤–∏–π –ø—ñ–¥–π–æ–º¬ª (Morning Boost).
      –¢—Ä–∏–≤–∞—î       60     —Ö–≤–∏–ª–∏–Ω        –ø—ñ—Å–ª—è       –ø—Ä–æ–±—É–¥–∂–µ–Ω–Ω—è            (ùë° ‚àà [ùë°wake , ùë°wake + 60]).
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è ¬´Ease-Out¬ª –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –Ω–∞–±–æ—Ä—É
—è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ —Ç–∞ –ø–æ—Å—Ç—É–ø–æ–≤–æ–≥–æ —É–ø–æ–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –ø—Ä–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ –¥–æ –º–∞–∫—Å–∏–º—É–º—É:
                     ùëá (ùë°) = ùêæmin + (ùêæmax ‚àí ùêæmin ) ‚ãÖ (1 ‚àí (1 ‚àí ùúè )2 )                          (3.3)
      –±)    –§–∞–∑–∞ ¬´–î–µ–Ω–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å¬ª (Daylight).
                                                                                          6
     –¢—Ä–∏–≤–∞—î –≤—ñ–¥ –∫—ñ–Ω—Ü—è —Ä–∞–Ω–∫–æ–≤–æ—ó —Ñ–∞–∑–∏ –¥–æ –ø–æ—á–∞—Ç–∫—É –≤–µ—á—ñ—Ä–Ω—å–æ–≥–æ –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è.
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—é –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ:
                                     ùëá (ùë°) = ùêæmax                                      (3.4)
     –≤)   –§–∞–∑–∞ ¬´–í–µ—á—ñ—Ä–Ω—è —Ä–µ–ª–∞–∫—Å–∞—Ü—ñ—è¬ª (Evening Relaxation).
     –ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è –≤—ñ–¥ –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è ùë°sunset —ñ —Ç—Ä–∏–≤–∞—î –¥–æ –≥–æ–¥–∏–Ω–∏ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º ùë°pre_sleep =
ùë°sleep ‚àí 60. –í—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ª—ñ–Ω—ñ–π–Ω–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ –¥–æ —Ä—ñ–≤–Ω—è ùêærelax , —â–æ —ñ–º—ñ—Ç—É—î
–ø—Ä–∏—Ä–æ–¥–Ω—ñ —Å—É—Ç—ñ–Ω–∫–∏:
                         ùëá (ùë°) = ùêæmax ‚àí (ùêæmax ‚àí ùêærelax ) ‚ãÖ ùúè                           (3.5)
     –≥)   –§–∞–∑–∞ ¬´–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —Å–Ω—É¬ª (Wind Down).
     –û—Å—Ç–∞–Ω–Ω—è    –≥–æ–¥–∏–Ω–∞     –ø–µ—Ä–µ–¥    —Å–Ω–æ–º    (ùë° ‚àà [ùë°pre_sleep , ùë°sleep ]).   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è ¬´Ease-In¬ª (ùúè 2 ) –¥–ª—è —Ä—ñ–∑–∫–æ–≥–æ –∑–Ω–∏–∂–µ–Ω–Ω—è —Å–∏–Ω—å–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞, —â–æ
—Å—Ç–∏–º—É–ª—é—î –≤–∏—Ä–æ–±–ª–µ–Ω–Ω—è –º–µ–ª–∞—Ç–æ–Ω—ñ–Ω—É:
                         ùëá (ùë°) = ùêærelax ‚àí (ùêærelax ‚àí ùêæmin ) ‚ãÖ ùúè 2                       (3.6)
     –£ –ø–µ—Ä—ñ–æ–¥ —Å–Ω—É (ùë° > ùë°sleep –∞–±–æ ùë° < ùë°wake ) —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ñ—ñ–∫—Å—É—î—Ç—å—Å—è –Ω–∞ —Ä—ñ–≤–Ω—ñ ùêæmin
(–∞–±–æ –≤–º–∏–∫–∞—î—Ç—å—Å—è –Ω—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º —á–µ—Ä–≤–æ–Ω–æ–≥–æ —Å–≤—ñ—Ç–ª–∞). –¢–∞–∫–∞ –º–æ–¥–µ–ª—å –¥–æ–∑–≤–æ–ª—è—î —Å–∏—Å—Ç–µ–º—ñ
–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –ø—ñ–¥ –∑–º—ñ–Ω—É —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ —Å–≤—ñ—Ç–ª–æ–≤–æ–≥–æ –¥–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º —Ä–æ–∫—É,
–∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –ø—Ä–∏–≤‚Äô—è–∑–∫—É –¥–æ —Å–æ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ —Ä–∏—Ç–º—É –∂–∏—Ç—Ç—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

     3.2.3 UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ

     –î–ª—è —ñ–ª—é—Å—Ç—Ä–∞—Ü—ñ—ó –ø—Ä–æ—Ü–µ—Å—É –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é (¬´PUT /profiles/
{id}¬ª) —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–æ –¥—ñ–∞–≥—Ä–∞–º—É –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ. –í–æ–Ω–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î —Å–∫–ª–∞–¥–Ω—É –ª–æ–≥—ñ–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
–ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É, –¥–µ —Ä—ñ—à–µ–Ω–Ω—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—ñ
–ø—Ä–æ—Ñ—ñ–ª—é (¬´is_shared¬ª).
                                                                                                                                                                                                7


                                                                              –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É PUT /profiles/{id}



                                                                                     –í–∞–ª—ñ–¥–∞—Ü—ñ—è JWT —Ç–æ–∫–µ–Ω–∞



                                                                                        –¢–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π?
                                                                                                  –Ω—ñ


                                                                                  –ü–æ–º–∏–ª–∫–∞ 401 Unauthorized




                                                                                 –í–∞–ª—ñ–¥–∞—Ü—ñ—è JSON (CreateProfile)



                                                                                          –î–∞–Ω—ñ –≤–∞–ª—ñ–¥–Ω—ñ?
                                                                                                  –Ω—ñ


                                                                              –ü–æ–º–∏–ª–∫–∞ 422 Unprocessable Entity




                                                                              –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –∑ –ë–î (row lock)



                                                                                         –ü—Ä–æ—Ñ—ñ–ª—å —ñ—Å–Ω—É—î?
                                                                                                  –Ω—ñ


                                                                                   –ü–æ–º–∏–ª–∫–∞ 404 Not Found




                                                                                 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞



    Role == Admin?                       Role == Owner?                                                                               Role == User?
           —Ç–∞–∫                                  —Ç–∞–∫                                                                                          —Ç–∞–∫


                               —Ç–∞–∫   –í–ª–∞—Å–Ω–∏–∫ == Auth.id OR    –Ω—ñ
 –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–µ–Ω–æ                 Shared –ø—Ä–æ—Ñ—ñ–ª—å –¥–∏—Ç–∏–Ω–∏?
                                                                                                                                                            –Ω—ñ
                                                                                  –í–ª–∞—Å–Ω–∏–∫ == Auth.id?                           Shared –ø—Ä–æ—Ñ—ñ–ª—å –±–∞—Ç—å–∫–∞?
                       –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–µ–Ω–æ         –ü–æ–º–∏–ª–∫–∞ 404 Not Found                    —Ç–∞–∫                                             —Ç–∞–∫

                                                                                                                              —Ç–∞–∫                      –Ω—ñ
                                                                                                                                    –ó–º—ñ–Ω–∞ is_shared?
                                                                               –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–µ–Ω–æ
                                                                                                                                                                        –ü–æ–º–∏–ª–∫–∞ 404 Not Found
                                                                                                                  –ü–æ–º–∏–ª–∫–∞ 403 Forbidden           –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª–µ–Ω–æ




                                                                                    –í–∏–∫–æ–Ω–∞–Ω–Ω—è SQL UPDATE



                                                                           –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é (200 OK)




                       –†–∏—Å—É–Ω–æ–∫ 3.1 ‚Äì UML –¥—ñ–∞–≥—Ä–∞–º–∞ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é

           3.2.4 –§—É–Ω–∫—Ü—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è

           –î–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–æ—é —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –Ω–∞–±—ñ—Ä —Ñ—É–Ω–∫—Ü—ñ–π, –¥–æ—Å—Ç—É–ø–Ω–∏—Ö
–≤–∏–∫–ª—é—á–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ —Ä–æ–ª–ª—é ¬´Admin¬ª. –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –∑–∞—Ö–∏—â–µ–Ω–æ
–æ–∫—Ä–µ–º–∏–º –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–æ–º ¬´AdminAuthenticated¬ª, —è–∫–∏–π –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–µ –ª–∏—à–µ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å
—Ç–æ–∫–µ–Ω–∞, –∞–ª–µ —ñ –ø–æ–ª–µ ¬´role¬ª —É ¬´Claims¬ª.
                                                                                      8
     3.2.5 –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ —Ç–∞ RBAC

     –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É (RBAC) —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —ñ—î—Ä–∞—Ä—Ö—ñ—é:
     –∞)    Admin: –ú–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤, –º–æ–∂–µ –≤–∏–¥–∞–ª—è—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ
           –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–æ–∫—Ä—ñ–º —Å–∞–º–æ–≥–æ —Å–µ–±–µ), –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É;
     –±)    Owner: –ö–µ—Ä—É—î —Å–≤–æ—ó–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Ç–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –Ω–∏–º
           –ø—ñ–¥–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (¬´User¬ª);
     –≤)    User: –ú–∞—î –æ–±–º–µ–∂–µ–Ω—ñ –ø—Ä–∞–≤–∞, –ø–µ—Ä–µ–≤–∞–∂–Ω–æ –Ω–∞ —á–∏—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ –≤–ª–∞—Å–Ω–∏–∫–∞.

–¢–∞–±–ª–∏—Ü—è 3.1 ‚Äì –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ
  –ú–µ—Ç–æ–¥            –ï–Ω–¥–ø–æ—ñ–Ω—Ç                          –û–ø–∏—Å —Ñ—É–Ω–∫—Ü—ñ—ó
  ¬´GET¬ª          ¬´/admin/stats¬ª        –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∫-—Å—Ç—å
                                         –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –¥–µ–≤–∞–π—Å—ñ–≤, –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)
  ¬´GET¬ª          ¬´/admin/users¬ª        –û—Ç—Ä–∏–º–∞–Ω–Ω—è    —Å–ø–∏—Å–∫—É   –≤—Å—ñ—Ö    –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö
                                                      –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
  ¬´GET¬ª       ¬´/admin/users/{id}¬ª      –ü–µ—Ä–µ–≥–ª—è–¥ –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –±—É–¥—å-
                                                    —è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
¬´DELETE¬ª      ¬´/admin/users/{id}¬ª      –ü—Ä–∏–º—É—Å–æ–≤–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É
                                           (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞ –ø–æ—Ä—É—à–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª)
   –ë—É–¥—å-           –ë—É–¥—å-—è–∫–∏–π           –ê–¥–º—ñ–Ω —ñ–≥–Ω–æ—Ä—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ –º–æ–∂–µ –≤—ñ–ª—å–Ω–æ
   —è–∫–∏–π                                            –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—ó


     3.2.6 –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–∞ –æ–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö

     –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–∞—Ç–µ—Ä–Ω—É ¬´Type-Driven Development¬ª –¥–æ–∑–≤–æ–ª—è—î –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏
–∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö —â–µ –¥–æ –ø–æ—á–∞—Ç–∫—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏. –ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –ø—Ä–∏–∫–ª–∞–¥
—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∑–∞–ø–∏—Ç—É –∑ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—é –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é:

      1    #[derive(Debug, Deserialize, Validate, ToSchema)]
      2    #[garde(allow_unvalidated)]
      3    pub struct CreateProfile {
      4        // –Ü–º'—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—É—Å—Ç–∏–º
      5        #[garde(length(chars, min = 1))]
      6        pub name: String,
      7
      8        // –û–±–º–µ–∂–µ–Ω–Ω—è —Ñ—ñ–∑–∏–∫–∏ —Å–≤—ñ—Ç–ª–æ–¥—ñ–æ–¥—ñ–≤
                                                                               9

       9          #[garde(range(min = 1800, max = 10000))]
      10          pub min_color_temp: i32,
      11
      12          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –ø–æ–ª—ñ–≤: max –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –º–µ–Ω—à–µ min
      13          #[garde(range(min = self.min_color_temp, max = 10000))]
      14          pub max_color_temp: i32,
      15
      16          // ... —ñ–Ω—à—ñ –ø–æ–ª—è
      17      }


      3.2.7 –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ—ó –º–æ–¥–µ–ª—ñ

      –û—Å–Ω–æ–≤–Ω–∏–º –µ–ª–µ–º–µ–Ω—Ç–æ–º –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ —î —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Å–≤—ñ—Ç–ª–∞. –ü–æ–≤–Ω–∏–π
–∫–æ–¥ –Ω–∞–≤–µ–¥–µ–Ω–æ –≤ –¥–æ–¥–∞—Ç–∫—É –ë. –§—É–Ω–∫—Ü—ñ—è ¬´interpolate_circadian_curve¬ª –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î
–ª—ñ–Ω—ñ–π–Ω—É —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—é —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–∏—Ä–æ–¥–Ω–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥—ñ–≤
—Å–≤—ñ—Ç–ª–∞:

          1   // –û–±—á–∏—Å–ª–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Å–≤—ñ—Ç–ª–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ö–≤–∏–ª–∏–Ω–∏ –¥–æ–±–∏
          2   fn calculate_at_time<T: TimeZone>(&self, local_time: &DateTime<T>)
              -> Result<i32, Error> {
       3          // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—á–Ω–æ–≥–æ —á–∞—Å—É –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è
       4          let (_, sunset_time) = match (self.latitude, self.longitude) {
       5              (Some(lat), Some(lon)) => Self::calculate_solar_times(
       6                  local_time.date_naive(), lat, lon
       7              )?,
       8              _ => self.estimate_solar_times(), // —è–∫—â–æ –Ω–µ–º–∞ –ª–æ–∫–∞—Ü—ñ—ó
       9          };
      10
      11          // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó —Ñ–∞–∑–∏ –¥–æ–±–∏ (—Ö–≤–∏–ª–∏–Ω–∏ –≤—ñ–¥ –ø—ñ–≤–Ω–æ—á—ñ)
      12          let current_minutes =
              local_time.time().num_seconds_from_midnight() / 60;
      13
      14          // ... –ª–æ–≥—ñ–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ñ–∞–∑–∏ —Å–Ω—É ...
      15
      16          // –Ü–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—è –∑–Ω–∞—á–µ–Ω—å
      17          Ok(self.interpolate_circadian_curve(
      18              current_minutes,
      19              sleep_end_minutes,   // –ß–∞—Å –ø—Ä–æ–±—É–¥–∂–µ–Ω–Ω—è
      20              sleep_start_minutes, // –ß–∞—Å —Å–Ω—É
      21              pre_sleep_minutes,   // –ß–∞—Å –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–æ —Å–Ω—É
      22              sunset_minutes,      // –ß–∞—Å –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è
      23          ))
      24      }


      3.2.8 –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

      –î–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ enum ¬´Error¬ª, —è–∫–∏–π
—ñ–º–ø–ª–µ–º–µ–Ω—Ç—É—î —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å ¬´IntoResponse¬ª. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –∑ —Ö–µ–Ω–¥–ª–µ—Ä—ñ–≤
                                                                             10
—è–∫ –∑–≤–∏—á–∞–π–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è ¬´Result¬ª, –∞ Axum –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç—É—î —ó—Ö —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ HTTP
—Å—Ç–∞—Ç—É—Å-–∫–æ–¥–∏, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:

      1   impl From<&Error> for StatusCode {
      2       fn from(value: &Error) -> Self {
      3           match value {
      4               // –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
      5               Error::UsernameTaken
      6               | Error::ProfileNameTaken => Self::CONFLICT,
      7
      8               // –ü—Ä–æ–±–ª–µ–º–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
      9               Error::WrongCredentials
     10               | Error::TokenExpired => Self::UNAUTHORIZED,
     11
     12               // –ü—Ä–æ–±–ª–µ–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (–±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞)
     13               Error::UsersCannotCreateUsers
     14               | Error::CannotChangeDeviceKey => Self::FORBIDDEN,
     15
     16               // –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ä–µ—Å—É—Ä—Å—ñ–≤
     17               Error::UserNotFound
     18               | Error::ProfileNotFound => Self::NOT_FOUND,
     19
     20               // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
     21               Error::InvalidData(_) => Self::UNPROCESSABLE_ENTITY,
     22
     23               // –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–æ–º–∏–ª–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç—É)
     24               _ => Self::INTERNAL_SERVER_ERROR,
     25           }
     26       }
     27   }


     3.3 –í–∏—Å–Ω–æ–≤–∫–∏

     –ü—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –±—É–ª–æ —É—Å–ø—ñ—à–Ω–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —è–¥—Ä–æ
–±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —á–∞—Å—Ç–∏–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ ¬´LumiRum¬ª, —â–æ –¥–æ–∑–≤–æ–ª–∏–ª–æ –ø–µ—Ä–µ–π—Ç–∏
–≤—ñ–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–±–æ—á–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç—É.
–ö–ª—é—á–æ–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Å—Ç–∞–ª–∞ –ø—Ä–æ–≥—Ä–∞–º–Ω–∞ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ—ó –º–æ–¥–µ–ª—ñ
—Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü–∏—Ä–∫–∞–¥–Ω–∏—Ö —Ä–∏—Ç–º—ñ–≤, —è–∫–∞ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—á–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω–Ω—è—Ö —Å—Ö–æ–¥—É
—Ç–∞ –∑–∞—Ö–æ–¥—É —Å–æ–Ω—Ü—è. –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –∑–∞–±–µ–∑–ø–µ—á—É—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—é
–ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —á–∞—Å—É –¥–æ–±–∏ —Ç–∞ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ–≥–æ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è, —â–æ —î
–≥–æ–ª–æ–≤–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—é –æ—Å–æ–±–ª–∏–≤—ñ—Å—Ç—é —Å–∏—Å—Ç–µ–º–∏.
     –û–∫—Ä–µ–º—É —É–≤–∞–≥—É –±—É–ª–æ –ø—Ä–∏–¥—ñ–ª–µ–Ω–æ —Ä–æ–∑—Ä–æ–±—Ü—ñ –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –º–µ—Ö–∞–Ω—ñ–∑–º—É –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö
—Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è. –ó–∞–≤–¥—è–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é –ø—ñ–¥—Ö–æ–¥—É Type-Driven Development —Ç–∞
–¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—ó –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó, —Å–∏—Å—Ç–µ–º–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤—É—î –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–∞–ø–∏—Ç–∏ —â–µ
                                                                                                                                                         11
–¥–æ –ø–æ—á–∞—Ç–∫—É —ó—Ö –æ–±—Ä–æ–±–∫–∏. –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–∞ —Ä–æ–ª—å–æ–≤–∞ –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø—É (RBAC) —Ä–∞–∑–æ–º
—ñ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—é —Å–∏—Å—Ç–µ–º–æ—é –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –¥–æ–∑–≤–æ–ª–∏–ª–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –±–µ–∑–ø–µ—á–Ω–µ
—Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ —Ç–∞ —Å–∏—Å—Ç–µ–º–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏,
–∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –ø—Ä–∏ —Ü—å–æ–º—É —á—ñ—Ç–∫–µ —Ä–æ–∑–º–µ–∂—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≤–∞–∂–µ–Ω—å –º—ñ–∂ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏,
–≤–ª–∞—Å–Ω–∏–∫–∞–º–∏ —Ç–∞ –∑–≤–∏—á–∞–π–Ω–∏–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏.
                                                                           12
                                 –î–û–î–ê–¢–û–ö –ê
                                   –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å

     –í—ñ–¥–µ–æ–∑–∞–ø–∏—Å –¥–æ–ø–æ–≤—ñ–¥—ñ: https://youtu.be/Y4a_FA3VVlI
     –•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –æ–ø–∏—Å –≤—ñ–¥–µ–æ–∑–∞–ø–∏—Å—É:
00:00 –í—Å—Ç—É–ø
00:09 –õ–æ–≥—ñ–Ω –∑ –∞–∫–∞—É–Ω—Ç—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
00:38 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞—Ö–∏—â–µ–Ω–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏
01:46 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–∫–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
02:02 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ–¥–ª–µ–≥–ª–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
02:21 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –≤—ñ–¥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
02:45 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –≤—ñ–¥ –ø—ñ–¥–ª–µ–≥–ª–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
03:04 –ü—Ä–æ—Ñ—ñ–ª—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—ñ–¥ –ª–∏—Ü—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
03:21 –ü—Ä–æ—Ñ—ñ–ª—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—ñ–¥ –ª–∏—Ü—è –ø—ñ–¥–ª–µ–≥–ª–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
03:34 –°–ø—Ä–æ–±–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
03:49 –°–ø—Ä–æ–±–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–≤–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
04:05 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±—ñ–∑–Ω–µ—Å –ª–æ–≥—ñ–∫–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Å–≤—ñ—Ç–ª–∞
06:07 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Å–≤—ñ—Ç–ª–∞ –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é –±–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
07:29 –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–µ–≤–∞–π—Å—É –∑ –ø—Ä–∏–≤'—è–∑–∞–Ω–∏–º –ø—Ä–æ—Ñ—ñ–ª–µ–º
07:48 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –º–æ–∂–µ –¥–µ–≤–∞–π—Å –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥
08:17 –ü—ñ–¥—Å—É–º–∫–∏
                                                                                   13
                                       –î–û–î–ê–¢–û–ö –ë
                   –ö–æ–¥ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ —Å–≤—ñ—Ç–ª–∞

–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ GitHub: https://github.com/NureBilousAnton/ark-pzpi-23-3-bilous-anton/blob/main/Lab3/ark-pzpi-23-3-bilous-anton-lab3/server/src/features/circadian.rs

        1      use chrono::{
        2          DateTime,
        3          Duration,
        4          NaiveDate,
        5          NaiveTime,
        6          TimeZone,
        7          Timelike,
        8          Utc,
        9      };
       10      use chrono_tz::Tz;
       11      use serde::{
       12          Deserialize,
       13          Serialize,
       14      };
       15      use sunrise::{
       16          Coordinates,
       17          SolarDay,
       18          SolarEvent,
       19      };
       20      use utoipa::ToSchema;
       21
       22      use crate::{
       23          errors::Error,
       24          features::profiles::Profile,
       25      };
       26
       27      /// Lighting schedule data sent to device
       28      #[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
       29      pub struct LightingSchedule {
       30          pub profile_id: i64,
       31
       32          #[schema(value_type = String)]
       33          pub timezone: Tz,
       34          #[schema(value_type = String, example = "22:00:00")]
       35          pub sleep_start: NaiveTime,
       36          #[schema(value_type = String, example = "07:00:00")]
       37          pub sleep_end: NaiveTime,
       38
       39          pub night_mode_enabled: bool,
       40
       41          pub generated_at: DateTime<Utc>,
       42          pub valid_until: DateTime<Utc>,
       43
       44          /// Lookup table of lighting data points
       45          pub schedule: Vec<LightingPoint>,
                                                                      14

46   }
47
48   #[derive(Debug, Clone, Serialize, Deserialize, ToSchema)]
49   pub struct LightingPoint {
50       /// Absolute UTC timestamp
51       #[serde(rename = "utc")]
52       pub timestamp: DateTime<Utc>,
53       /// Color temperature in Kelvin
54       #[serde(rename = "temp")]
55       pub color_temp: i32,
56   }
57
58   impl Profile {
59       /// Compute a lighting schedule for a profile
60       pub fn calculate(&self, points: u16, offset: Duration) ->
     Result<LightingSchedule, Error> {
61           let now = Utc::now();
62           let timezone = self.timezone.parse()?;
63
64            let mut schedule = Vec::with_capacity(points.into());
65
66            for timestamp in (0..points.into()).map(|i| now + offset
     * i) {
67               schedule.push(LightingPoint {
68                   timestamp,
69                   color_temp:
     self.calculate_at_time(&timestamp.with_timezone(&timezone))?,
70               });
71           }
72
73            Ok(LightingSchedule {
74                profile_id: self.id,
75                timezone,
76                sleep_start: self.sleep_start,
77                sleep_end: self.sleep_end,
78                night_mode_enabled: self.night_mode_enabled,
79
80                 generated_at: now,
81                 valid_until: now + offset * points.into(),
82                 schedule,
83            })
84       }
85
86       /// Calculate color temperature for a specific local time
87       fn calculate_at_time<T: TimeZone>(&self, local_time:
     &DateTime<T>) -> Result<i32, Error> {
88           let (_, sunset_time) = if let (Some(lat), Some(lon)) =
     (self.latitude, self.longitude) {
89               Self::calculate_solar_times(local_time.date_naive(),
     lat, lon)?
90           } else {
91               self.estimate_solar_times()
92           };
93
                                                                       15

94            // Convert all times to minutes from midnight for easier
      comparison
95            let current_minutes =
      local_time.time().num_seconds_from_midnight() / 60;
96
97            let sleep_start_minutes =
      self.sleep_start.num_seconds_from_midnight() / 60;
98            let sleep_end_minutes =
      self.sleep_end.num_seconds_from_midnight() / 60;
 99
100           let sunset_minutes =
      sunset_time.num_seconds_from_midnight() / 60;
101
102           // Determine if we're in sleep period
103           let in_sleep_period = if sleep_start_minutes <
      sleep_end_minutes {
104               // Sleep doesn't cross midnight (e.g. 2:00-10:00)
105               current_minutes >= sleep_start_minutes &&
      current_minutes < sleep_end_minutes
106           } else {
107               // Sleep crosses midnight (e.g. 22:00-06:00)
108               current_minutes >= sleep_start_minutes ||
      current_minutes < sleep_end_minutes
109           };
110
111           if in_sleep_period {
112               return Ok(self.min_color_temp);
113           }
114
115           // We start winding down 60 mins before bed
116           let pre_sleep_minutes = if sleep_start_minutes >= 60 {
117               sleep_start_minutes - 60 // 1 hour before sleep
118           } else {
119               23 * 60 + sleep_start_minutes // Handle midnight
      crossing
120           };
121
122           // Calculate color temperature using piecewise function
123           Ok(self.interpolate_circadian_curve(
124               current_minutes,
125               sleep_end_minutes,   // Wake time
126               sleep_start_minutes, // Sleep time
127               pre_sleep_minutes,   // Wind down time
128               sunset_minutes,
129           ))
130       }
131
132       /// Calculate sunrise and sunset times using astronomical
      algorithms
133       fn calculate_solar_times(
134           date: NaiveDate,
135           latitude: f64,
136           longitude: f64,
                                                                   16

137     ) -> Result<(NaiveTime, NaiveTime), Error> {
138         let coord = Coordinates::new(latitude,
    longitude).ok_or(Error::DataCorruption(format!(
139             "Invalid coordinates: {latitude}, {longitude}"
140         )))?;
141         let solar_day = SolarDay::new(coord, date);
142
143         let sunrise =
    solar_day.event_time(SolarEvent::Sunrise).time();
144         let sunset =
    solar_day.event_time(SolarEvent::Sunset).time();
145
146         Ok((sunrise, sunset))
147     }
148
149     /// Estimate solar times based on sleep schedule when
    location is missing:
150     /// - Sunrise aligns with Wake Up time (user needs light to
    wake up).
151     /// - Sunset is approximated 2 hours before Sleep Start to
    allow for an evening relaxation phase.
152     fn estimate_solar_times(&self) -> (NaiveTime, NaiveTime) {
153         let sleep_start_seconds =
    self.sleep_start.num_seconds_from_midnight();
154         let offset_seconds = 2 * 3600; // 2 hours
155
156         // Handle wrapping around midnight
157         let sunset_seconds = if sleep_start_seconds >=
    offset_seconds {
158             sleep_start_seconds - offset_seconds
159         } else {
160             // e.g. sleep at 01:00, 3600s - 2h = 23:00 prev day
161             24 * 3600 - (offset_seconds - sleep_start_seconds)
162         };
163
164         #[allow(clippy::expect_used)]
165         let sunset =
    NaiveTime::from_num_seconds_from_midnight_opt(sunset_seconds, 0)
166             .unwrap_or(NaiveTime::from_hms_opt(20, 0,
    0).expect("valid time"));
167
168         (self.sleep_end, sunset)
169     }
170
171     /// Calculates curve with 4 phases:
172     /// 1. Wake -> Morning Boost (Min -> Max)
173     /// 2. Day -> Sunset (Hold Max)
174     /// 3. Sunset -> Pre-Sleep (Max -> Relaxation Temp)
175     /// 4. Pre-Sleep -> Sleep (Relaxation Temp -> Min)
176     #[allow(clippy::too_many_arguments)]
177     fn interpolate_circadian_curve(
178         &self,
179         current_minutes: u32,
                                                                      17

180         wake_minutes: u32,
181         sleep_minutes: u32,
182         pre_sleep_minutes: u32,
183         sunset_minutes: u32,
184     ) -> i32 {
185         // Define an "Evening/Relaxation" temperature
186         // This is warmer than daylight but brighter than
    nightlight
187         // e.g. if Max=6500, Min=2000, Relax = 3500
188         let relax_temp = self.min_color_temp +
    (self.max_color_temp - self.min_color_temp) / 3;
189
190         // Helper to check time range which may wrap midnight
191         let in_range = |curr: u32, start: u32, end: u32| -> bool
    {
192             if start <= end {
193                 curr >= start && curr < end
194             } else {
195                 curr >= start || curr < end
196             }
197         };
198
199         // Helper for linear interpolation 0.0 -> 1.0
200         let get_t = |curr: u32, start: u32, end: u32| -> f64 {
201             if start <= end {
202                 if curr < start {
203                      return 0.0;
204                 }
205                 if curr > end {
206                      return 1.0;
207                 }
208                 f64::from(curr - start) / f64::from(end - start)
209             } else {
210                 let total = f64::from(24 * 60 - start + end);
211                 let val = if curr >= start {
212                      f64::from(curr - start)
213                 } else {
214                      f64::from(24 * 60 - start + curr)
215                 };
216                 val / total
217             }
218         };
219
220         // Morning ramp-up duration, 60 mins after waking
221         let morning_end_minutes = (wake_minutes + 60) % 1440;
222
223         // PHASE 1: Morning Boost (Wake -> Wake+1h)
224         if in_range(current_minutes, wake_minutes,
    morning_end_minutes) {
225             let t = get_t(current_minutes, wake_minutes,
      morning_end_minutes);
226               // Ease-out (fast rise, slow finish)
227               let t_eased = (1.0 - t).mul_add(-(1.0 - t), 1.0);
228               #[allow(clippy::cast_possible_truncation)]
229               return self.min_color_temp
                                                                   18

230                  + (f64::from(self.max_color_temp -
    self.min_color_temp) * t_eased) as i32;
231         }
232
233         // PHASE 4: Final Wind Down (Pre-Sleep -> Sleep)
234         // We check this before Phase 2/3 to ensure user sleep
    schedule overrides solar sunset
235         if in_range(current_minutes, pre_sleep_minutes,
    sleep_minutes) {
236             let t = get_t(current_minutes, pre_sleep_minutes,
    sleep_minutes);
237             // Ease-in (slow drop start, fast finish)
238             let t_eased = t.powi(2);
239             // Drop from Relax Temp to Min Temp
240             #[allow(clippy::cast_possible_truncation)]
241             return relax_temp - (f64::from(relax_temp -
    self.min_color_temp) * t_eased) as i32;
242         }
243
244         // PHASE 3: Evening Relaxation (Sunset -> Pre-Sleep)
245         // We need to check if Sunset happens before Pre-Sleep
246         // If Sunset is super late (summer) or after pre_sleep,
    we skip this logic
247         // NOTE: We use sunset_minutes as start,
    pre_sleep_minutes as end.
248         if in_range(current_minutes, sunset_minutes,
    pre_sleep_minutes) {
249             // Determine effective start/end for interpolation
250             // If we are here, we are between sunset and pre-
    sleep
251             let t = get_t(current_minutes, sunset_minutes,
    pre_sleep_minutes);
252             // Linear drop from Max to Relax
253             #[allow(clippy::cast_possible_truncation)]
254             return self.max_color_temp -
    (f64::from(self.max_color_temp - relax_temp) * t) as i32;
255         }
256
257         // PHASE 2: Daylight (Morning End -> Sunset OR Pre-Sleep)
258         // If we haven't hit sunset yet, or if sunset is weirdly
    placed, keep it bright.
259         // Also captures the "gap" if sunrise is way before wake
    time (handled by default max).
260
261         // Simply returning max_temp covers the remaining
    productive hours.
262         self.max_color_temp
263     }
264 }

