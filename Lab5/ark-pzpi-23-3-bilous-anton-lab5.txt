                    МІНІСТЕРСТВО ОСВІТИ І НАУКИ УКРАЇНИ
   ХАРКІВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ РАДІОЕЛЕКТРОНІКИ



                           Кафедра Програмної інженерії




                                        Звіт
                             з лабораторної роботи №5
                     з дисципліни: «Аналіз та рефакторинг коду»
       з теми: «Розгортання програмної системи та демонстрація її роботи»




Виконав:                                                               Перевірив:
ст. гр. ПЗПІ-23-3                                                 ст. викл. каф. ПІ
Білоус А. А.                                                        Сокорчук І. П.




                                   Харків – 2025
                                                                             2
   5 РОЗГОРТАННЯ ПРОГРАМНОЇ СИСТЕМИ ТА ДЕМОНСТРАЦІЯ ЇЇ
                                    РОБОТИ

     5.1 Мета роботи

     Навчитися розгортати програмну систему, перевіряти її функціональність,
виконувати налаштування, а також демонструвати та документувати роботу
системи.

     5.2 Хід роботи
     5.2.1 Розгортання програмної системи

     Для забезпечення переносимості, ізоляції та простоти розгортання серверної
частини системи «LumiRum» було обрано технологію контейнеризації Docker та
інструмент оркестрації Docker Compose. Цей підхід дозволяє розгорнути як веб-
сервер, так і базу даних однією командою, гарантуючи ідентичність середовища
розробки та виконання.

     5.2.1.1 Отримання вихідного коду

     Актуальна версія програмного забезпечення знаходиться у системі контролю
версій GitHub. Для початку роботи було виконано клонування репозиторію на
цільову машину (сервер розгортання):

     git clone https://github.com/noatu/lumirum
     cd lumirum


     5.2.1.2 Конфігурація середовища (Docker Compose)

     Файл конфігурації «compose.yml» описує два основні сервіси: базу даних та
сервер застосунку. Його вміст знаходиться в додатку Б.
     Сервіс «database»:
      –    використовує офіційний образ «postgres:18»;
      –    порт «5432» прокидається на хост-машину для можливості прямого
           підключення адміністратором;
                                                                                   3
      –   дані зберігаються у іменованому томі «data», що забезпечує
          персистентність (збереження даних) навіть після перестворення
          контейнерів;
      –   змінні оточення задають ім’я бази даних та пароль.
     Сервіс «app» (Серверна частина):
      –   базується на образі «rustlang/rust:nightly», що містить необхідні
          інструменти компіляції;
      –   використовує підхід «Dev-Container»: вихідний код монтується у
          контейнер («.:/app:ro»), і компіляція відбувається під час запуску («cargo
          run --release»). Це спрощує процес оновлення коду без необхідності
          створення окремих Docker-образів для кожної зміни;
      –   безпека: Реалізовано автоматичну генерацію секретного ключа для JWT.
          Скрипт запуску перевіряє наявність файлу секрету, і якщо його немає –
          генерує новий за допомогою «openssl» та зберігає у том «secrets»;
      –   порт «3000» відкривається для доступу клієнтів (IoT пристроїв та веб-
          інтерфейсу).

     5.2.1.3 Процес розгортання

     Запуск системи виконується командою:

     docker compose up -d


     Прапор «-d» (detached) дозволяє запустити контейнери у фоновому режимі.
Оскільки образ «app» виконує повну компіляцію проекту Rust при першому запуску,
процес ініціалізації може зайняти певний час (завантаження залежностей crates.io
та збірка бінарного файлу). Наступні рекомпіляції є швишкими через кешування
залежностей та їх скомпільованих артефактів.
     Перевірка статусу контейнерів виконана командою «docker compose ps»:

     NAME               IMAGE                 SERVICE PORTS
     lumirum-app-1      rustlang/rust:nightly app      0.0.0.0:3000->3000
     lumirum-database-1 postgres:18           database 0.0.0.0:5432->5432
                                                                                 4
     5.2.1.4 Розгортання IoT клієнта

     Оскільки IoT клієнт є вбудованим програмним забезпеченням для
мікроконтролера ESP32-C3, його «розгортання» полягає у компіляції прошивки та
завантаженні її на пристрій (або симулятор).
      а)    У файлі «src/config.h» було налаштовано адресу API сервера. Оскільки
            сервер запущено локально, а симулятор Wokwi використовує віртуальний
            мережевий шлюз, адреса встановлена відповідно до налаштувань
            локальної мережі хоста:

                  #define API_BASE_URL "http://192.168.18.103:3000"

     б)     Компіляція та завантаження виконані через PlatformIO:

                  pio run

     У даній лабораторній роботі використовується емулятор Wokwi, який
через шлюз «Wokwi-GUEST» забезпечує доступ емульованого ESP32 до Docker-
контейнера з бекендом, запущеного на хост-машині.

     5.2.2 Перевірка та налаштування роботи розгорнутої системи

     Після      запуску     контейнерів   було   проведено   комплексну   перевірку
працездатності компонентів системи.

     5.2.2.1 Перевірка доступності сервера та бази даних

     Для автоматизованої перевірки стану системи реалізовано ендпоінт «/health».
Він виконує тестовий запит до бази даних (перевірка з’єднання) та повертає статус
сервера.
     Запит:

     curl -X GET http://localhost:3000/health


     Відповідь (200 OK):

     {
           "status": "healthy",
           "timestamp": "2025-12-26T11:21:17.429070177Z"
     }
                                                                              5
     Отримання статусу «healthy» підтверджує, що:
     а)    веб-сервер (Axum) запущено та він приймає запити на порту 3000;
     б)    контейнер бази даних («database») запущено;
     в)    мережевий міст між контейнерами налаштовано коректно;
     г)    змінна оточення «DATABASE_URL» передана правильно, і сервер зміг
           авторизуватися в PostgreSQL.

     5.2.2.2 Налаштування параметрів

     Налаштування поведінки системи виконано через змінні оточення у файлі
«compose.yml». Зокрема:
     –     «RUST_LOG: info» – встановлено рівень логування, що відстежувати
           статус системи в консолі Docker;
     –     «JWT_SECRET_FILE» – налаштовано механізм роботи з секретами.
           При першому запуску система автоматично згенерувала криптографічно
           стійкий ключ, що гарантує безпеку токенів автентифікації.

     5.2.3 Демонстрація функціональності (згідно Vision & Scope)

     Відповідно до розділу 2.2 документу Vision & Scope, система повинна
забезпечувати рольову модель доступу, керування циркадними ритмами та збір
телеметрії. Нижче наведено демонстрацію цих функцій через API.

     5.2.3.1 Функції адміністрування та рольова модель

     Система підтримує ієрархію ролей: Адміністратор -> Власник -> Користувач.
     Отримання токену адміністратора:

     curl http://localhost:3000/auth/login \
         --request POST \
         --header 'Content-Type: application/json' \
         --data '{"password": "lumirum!", "username": "admin"}'


     Відповідь:

     {
          "id": 1,
          "username": "admin",
          "role": "admin",
                                                                               6
        "created_at": "2025-12-26T11:06:01.664852Z",
        "token":
      "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsInJvbGUiOiJhZG1pbiIsImV4c
      n5t-DOXgoasV071SuBahxOIZGow3Ba8oT8UqBA"
      }


      Перегляд глобальної статистики (доступно тільки Адміністратору).
      Адміністратор може оцінити навантаження на систему через ендпоінт «/stats».
      Запит (з токеном адміністратора):

      curl http://localhost:3000/stats \
         --header 'Authorization: Bearer
      eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsInJvbGUiOiJhZG1pbiIsImV4cC
      n5t-DOXgoasV071SuBahxOIZGow3Ba8oT8UqBA'


      Відповідь:

      {
          "users": 1,
          "profiles": 0,
          "devices": 0,
          "telemetry": 0,
          "timestamp": "2025-12-26T11:29:19.016801981Z"
      }


      Керування користувачами. Адміністратор має можливість переглядати список
усіх користувачів через «/users»:

      curl http://localhost:3000/users \
        --header 'Authorization: Bearer
      eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjEsInJvbGUiOiJhZG1pbiIsImV4cC
      n5t-DOXgoasV071SuBahxOIZGow3Ba8oT8UqBA'


      Відповідь:

      [
          {
              "id": 1,
              "username": "admin",
              "role": "admin",
              "created_at": "2025-12-26T11:06:01.664852Z"
          }
      ]
                                                                          7
      5.2.3.2 Реалізація бізнес-логіки (Адаптивне освітлення)

      Основною бізнес-функцією є створення профілів освітлення та розрахунок
графіків.
      Створення профілю. Користувач створює профіль, вказуючи геолокацію та
бажані параметри сну:

      curl http://localhost:3000/profiles \
          --request POST \
          --header 'Content-Type: application/json' \
          --header 'Authorization: Bearer
      eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjIsInJvbGUiOiJvd25lciIsImV4cC
      \
          --data '{
        "is_shared": true,
        "latitude": 49.98081,
        "longitude": 36.25272,
        "max_color_temp": 6500,
        "min_color_temp": 2000,
        "motion_timeout_seconds": 300,
        "name": "Living Room",
        "night_mode_enabled": true,
        "sleep_end": "07:00:00",
        "sleep_start": "22:00:00",
        "timezone": "Europe/Kyiv"
      }'


      Результат POST /profiles:

      {
          "id": 1,
          "name": "Living Room",
          "owner_id": 2,
          "is_shared": true,
          "latitude": 49.98081,
          "longitude": 36.25272,
          "timezone": "Europe/Kyiv",
          "sleep_start": "22:00:00",
          "sleep_end": "07:00:00",
          "night_mode_enabled": true,
          "min_color_temp": 2000,
          "max_color_temp": 6500,
          "motion_timeout_seconds": 300,
          "created_at": "2025-12-26T11:33:19.309508Z"
      }


      Тепер свторимо девайс з цим профілем:

      curl http://localhost:3000/devices \
          --request POST \
          --header 'Content-Type: application/json' \
                                                                               8
         --header 'Authorization: Bearer
     eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjIsInJvbGUiOiJvd25lciIsImV4cC
     \
         --data '{
       "is_public": true,
       "name": "Kitchen Light",
       "profile_id": 1
     }'


     Результат POST /devices:

     {
       "id": 1,
       "name": "Kitchen Light",
       "secret_key":
     "5A2EKdOmxDmk1sdDS9YXHtCSVnHbCFch71Y5wKXIbqSHVPiTblWU1wf16excyiTS",
       "profile_id": 1,
       "owner_id": 2,
       "is_public": true,
       "firmware_version": null,
       "last_seen": null,
       "created_at": "2025-12-26T11:36:49.544498Z"
     }


     Найскладнішою     частиною    бізнес-логіки   є   розрахунок   точок   зміни
температури. Це демонструється запитом до «/devices/circadian», який виконує IoT-
пристрій (або симулятор).
     Запит (з використанням API ключа пристрою):

     curl http://localhost:3000/devices/circadian \
           --header 'x-api-key:
     5A2EKdOmxDmk1sdDS9YXHtCSVnHbCFch71Y5wKXIbqSHVPiTblWU1wf16excyiTS'


     Отримана відповідь (фрагмент):

     {
         "profile_id": 1,
         "sleep_start_utc_seconds": 72000,
         "sleep_end_utc_seconds": 18000,
         "min_color_temp": 2000,
         "max_color_temp": 6500,
         "night_mode_enabled": true,
         "motion_timeout_seconds": 300,
         "generated_at": "2025-12-26T11:38:12.365280374Z",
         "valid_until": "2025-12-27T11:38:12.365280374Z",
         "schedule": [
           { "utc": "2025-12-26T11:38:12.365280374Z", "temp": 6500 },
           { "utc": "2025-12-26T11:53:12.365280374Z", "temp": 6399 },

          { "utc": "2025-12-26T14:53:12.365280374Z", "temp": 5177 },
          { "utc": "2025-12-26T15:08:12.365280374Z", "temp": 5075 },
                                                                              9

               { "utc": "2025-12-26T18:23:12.365280374Z", "temp": 3752 },
               { "utc": "2025-12-26T18:38:12.365280374Z", "temp": 3650 },

               { "utc": "2025-12-26T19:53:12.365280374Z", "temp": 2330 },
               { "utc": "2025-12-26T20:08:12.365280374Z", "temp": 2000 },

               { "utc": "2025-12-27T04:53:12.365280374Z", "temp": 2000 },
               { "utc": "2025-12-27T05:08:12.365280374Z", "temp": 3119 },
               { "utc": "2025-12-27T05:23:12.365280374Z", "temp": 4788 },
               { "utc": "2025-12-27T05:38:12.365280374Z", "temp": 5895 },
               { "utc": "2025-12-27T05:53:12.365280374Z", "temp": 6438 },
               { "utc": "2025-12-27T06:08:12.365280374Z", "temp": 6500 },

               { "utc": "2025-12-27T11:23:12.365280374Z", "temp": 6500 }
           ]
      }


      Наявність цього розкладу підтверджує коректну роботу математичного
модуля на сервері (розрахунок сходу/заходу сонця за координатами та інтерполяція
кривої).

      5.2.3.3 Збір телеметрії та моніторинг

      Система приймає дані від пристроїв та зберігає їх для історії.
      Відправка телеметрії, запит POST /telemetry:

      curl http://localhost:3000/telemetry \
            --request POST \
            --header 'Content-Type: application/json' \
            --header 'x-api-key:
      5A2EKdOmxDmk1sdDS9YXHtCSVnHbCFch71Y5wKXIbqSHVPiTblWU1wf16excyiTS' \
            --data '{
        "ambient_light": null,
        "brightness": null,
        "color_temp": null,
        "event_type": "motion_detected",
        "light_is_on": null,
        "motion_detected": null
      }'


      Результат:

      {
           "id": 1,
           "device_id": 1,
           "event_type": "motion_detected",
           "motion_detected": null,
           "light_is_on": null,
           "brightness": null,
           "color_temp": null,
                                                                               10
         "ambient_light": null,
         "created_at": "2025-12-26T11:43:27.783363Z"
     }


     Власник може переглянути історію подій за певний період через «/telemetry?
start=...&end=...». Це дозволяє аналізувати активність у приміщенні.
     Запит:

     curl 'http://localhost:3000/telemetry?start=2025-12-10T00:00:00Z&end=
     2025-12-31T00:00:00Z' \
       --header 'Authorization: Bearer
     eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOjIsInJvbGUiOiJvd25lciIsImV4cC


     Відповідь:

     [{
       "id": 1,
       "device_id": 1,
       "event_type": "motion_detected",
       "motion_detected": null,
       "light_is_on": null,
       "brightness": null,
       "color_temp": null,
       "ambient_light": null,
       "created_at": "2025-12-26T11:43:27.783363Z"
     }]


     Як можемо побачити, телеметрія присутня на сервері.

     5.2.4 UML діаграма діяльності серверу

     Для ілюстрації процесу обробки запиту на оновлення профілю («PUT /
profiles/{id}») розроблено діаграму діяльності (див. Рисунок 5.1). Вона демонструє
складну логіку перевірки прав доступу, де рішення залежить від ролі користувача
та налаштувань приватності профілю («is_shared»).
                                                                                                                                                                                                11


                                                                              Отримання запиту PUT /profiles/{id}



                                                                                     Валідація JWT токена



                                                                                        Токен валідний?
                                                                                                  ні


                                                                                  Помилка 401 Unauthorized




                                                                                 Валідація JSON (CreateProfile)



                                                                                          Дані валідні?
                                                                                                  ні


                                                                              Помилка 422 Unprocessable Entity




                                                                              Отримання профілю з БД (row lock)



                                                                                         Профіль існує?
                                                                                                  ні


                                                                                   Помилка 404 Not Found




                                                                                 Перевірка ролі користувача



    Role == Admin?                       Role == Owner?                                                                               Role == User?
           так                                  так                                                                                          так


                               так   Власник == Auth.id OR    ні
 Оновлення дозволено                 Shared профіль дитини?
                                                                                                                                                            ні
                                                                                  Власник == Auth.id?                           Shared профіль батька?
                       Оновлення дозволено         Помилка 404 Not Found                    так                                             так

                                                                                                                              так                      ні
                                                                                                                                    Зміна is_shared?
                                                                               Оновлення дозволено
                                                                                                                                                                        Помилка 404 Not Found
                                                                                                                  Помилка 403 Forbidden           Оновлення дозволено




                                                                                    Виконання SQL UPDATE



                                                                           Повернення оновленого профілю (200 OK)




                       Рисунок 5.1 – UML діаграма діяльності оновлення профілю

           5.2.5 UML діаграма прецедентів IoT пристрою

           Для моделювання функціональних вимог до IoT клієнта та його взаємодії з
навколишнім середовищем розроблена діаграма прецедентів (див. Рисунок 5.2).
           Діаграма виділяє трьох основних акторів:
                                                                                                                                                                                    12
            а)       фізичний користувач: Людина, яка знаходиться в приміщенні та взаємодіє
                     з системою через фізичні інтерфейси (кнопка, датчики, візуальне
                     сприйняття світла);
           б)        адміністратор (Web): Користувач, який виконує первинне налаштування
                     пристрою або відновлення доступу через локальний веб-інтерфейс;
           в)        сервер LumiRum: Зовнішня система, яка надає дані розкладу та приймає
                     телеметрію.
           Основні сценарії використання (Use Cases):
            а)       Забезпечення адаптивного освітлення: Головний прецедент, що включає в
                     себе алгоритмічне керування LED-стрічкою на основі часу доби та даних
                     з сенсорів;
           б)        Взаємодія з сервером: Пристрій виступає ініціатором з’єднання для
                     отримання актуального розкладу циркадних ритмів («Fetch Schedule») та
                     відправки звітів про події («Send Telemetry»);
           в)        Керування режимами: Користувач може фізично впливати на роботу
                     пристрою, перемикаючи режими (Авто/Ручний) кнопкою або змінюючи
                     яскравість потенціометром;
            г)       Конфігурація: У випадку відсутності авторизації (помилка 401) або
                     першого запуску, пристрій надає веб-інтерфейс для введення API ключа.


          Веб користувач                                            Фізичний користувач                                                          С ервер

                                                                                     IoT Клієнт
 Через Веб Браузер                                        Переміщення в зоні дії
                                                                                                                                  (JSON Schedule)
                                                                                                                                                        (POST Events)
         Адміністрування                                              Фізична взаємодія
                                                                                                                                        Ме р е же в а в з а є мод і я


     Налаштування API ключа      Регулювання яскравості            Виявлення присутності          Перемикання режиму     Отримання розкладу                  Відправка телеметрії
                                                                                                     (Авто/Ручний)
                                                    «include»
         «extends»                                                     «include»                                           «include»



       Відображення статусу                                      Забе зпечення адаптивного                   «include»
                                                                                                                         Синхронізація часу NTP
             п ом и л к и                                                о світлення




                              Рисунок 5.2 – UML діаграма прецедентів IoT клієнта

           5.2.6 UML діаграма діяльності IoT пристрою

           Для візуалізації алгоритмів роботи програмного забезпечення IoT клієнта
розроблено діаграму діяльності (див. Рисунок 5.3): від моменту подачі живлення до
переходу в основний цикл роботи або режим конфігурації.
                                                                         13
Діаграма демонструє наступні ключові процеси:
а)   ініціалізація: Налаштування портів вводу-виводу (GPIO), завантаження
     збережених налаштувань з енергонезалежної пам’яті та встановлення
     з’єднання з мережею WiFi;
б)   валідація авторизації: Перевірка API ключа шляхом спроби завантаження
     розкладу. У разі невдачі (HTTP 401) система блокує основний цикл і
     переходить у режим веб-сервера для налаштування;
в)   основний цикл (Main Loop): Безперервне опитування датчиків,
     розрахунок параметрів освітлення на основі часу та кешованого розкладу,
     а також керування LED-стрічкою;
г)   асинхронна телеметрія: Відправка даних на сервер лише при зміні стану
     системи, що економить мережеві ресурси.
                                                                                                                         14


                                    Ініціалізація Serial, GPIO, LED



                         Завантаження налаштувань (NVS Preferences)


                           Мережеве підключення

                                     так
                                             WiFi підключено?
                                                     ні



                                    Спроба підключення до WiFi



                                      Перевищено ліміт спроб?
                                                     так


                                      Робота в офлайн режимі




                                      Синхронізація часу (NTP)



      Отримання конфігурації


                                    Запит GET /devices/circadian


                              так                                       ні
                                     Відповідь 401 Unauthorized?


         Встановлення прапора isInConfigMode                           Парсинг JSON



             Увімкнення червоної індикації                  Кешування розкладу в RAM



            Запуск Web-сервера налаштувань



  Основний цикл (Loop)

                                               Живлення є


                                    так                           ні
                                           Режим конфігурації?


       Обробка запитів Web-клієнтів                         Зчитування стану кнопки та потенціометра


                                                                  так                                ні
                                                                             Датчик руху активний?


                                                                                              Таймер активності сплив?
                                                Скидання таймера активності
                                                                                                          так


                                                                                                 Вимкнення світла
                                                      Увімкнення світла




                                                                 Розрахунок колірної температури



                                                                  Оновлення кольору LED-стрічки



                                                                                Стан змінився?
                                                                                        так


                                                                   POST /telemetry (Асинхронно)




                                                                  Таймер оновлення розкладу сплив?
                                                                                        так


                                                                  Оновлення розкладу з сервера




                                          Затримка (Loop Delay)




Рисунок 5.3 – UML діаграма діяльності IoT клієнта
                                                                               15
     Код PlantUML для генерації діаграми:

     5.3 Висновки

     Під час виконання лабораторної роботи було набуто практичних навичок
розгортання розподіленої програмної системи «LumiRum» з використанням
технологій контейнеризації. Застосування Docker та інструменту оркестрації Docker
Compose дозволило створити ізольоване та відтворюване середовище для серверної
частини, написаної на Rust, та реляційної бази даних PostgreSQL. Такий підхід
значно спрощує процес налаштування інфраструктури та гарантує ідентичність
оточення на етапах розробки та експлуатації.
     У ході роботи було виконано конфігурування параметрів запуску через змінні
оточення, налаштовано мережеву взаємодію між контейнерами та забезпечено
персистентність даних за допомогою Docker volumes. Особливу увагу було
приділено аспектам безпеки при розгортанні, зокрема автоматичній генерації
секретних ключів для підпису JWT-токенів при першому запуску системи.
     Проведене комплексне тестування підтвердило стабільність та коректність
роботи   всіх   компонентів   системи    як    єдиного   цілого.   Було   успішно
продемонстровано реалізацію функціональних вимог, описаних у документі Vision
& Scope, включаючи рольову модель доступу, алгоритми розрахунку циркадних
ритмів та збір телеметрії від IoT-пристроїв. Взаємодія між емульованим клієнтом
та розгорнутим API відбувається згідно зі специфікацією OpenAPI, що свідчить про
готовність системи до подальшого використання.
                                                                           16
                                   ДОДАТОК А
                                     Відеозапис

     Відеозапис доповіді: https://youtu.be/V2izl9tUBdg
     Хронологічний опис відеозапису:
00:00 Вступ та розгортання бекенду
00:52 Перевірка стану запущеного бекенду
01:09 Логін з акаунту адміністратора
01:38 Перевірка захищенності системи
02:46 Перевірка логіки створення користувачів
03:02 Створення підлеглого користувача
03:21 Створення профілів від основного користувача
03:45 Створення профілів від підлеглого користувача
04:04 Профілі доступні від лиця основного користувача
04:21 Профілі доступні від лиця підлеглого користувача
04:34 Спроба видалення публічного профілю іншого користувача
04:49 Спроба видалення свого профілю
05:05 Перевірка бізнес логіки розрахунку температури світла
07:07 Перевірка розрахунку температури світла для профілю без геолокації
08:29 Створення девайсу з прив'язаним профілем
08:48 Перевірка чи може девайс отримати розклад
09:18 Інформація пристрою на сервері
09:27 Оновлення API ключа пристрою
09:42 Компіляція оновленної прошивки
09:51 Запуск пристрою
10:15 Опис профілю освітлення на сервері
10:48 Інформація розкладу освітлення котру отримує девайс
11:12 Перевірка статусу пристрою
11:26 Примусове оновлення розкладу освітлення
11:39 Перевірка реакції на датчик руху
12:07 Перевірка надходження телеметрії на сервер
12:21 Тестування таймеру вимкнення світла
                                                                          17
12:33 Перевірка зміни температури кольору в залежності від часу
13:40 Перевірка праці при застарілому розкладі освітлення
14:18 Регулювання яскравості світла та перемикання між автоматичним та ручним
режимом
14:49 Перевірка записів телеметрії на сервері
15:03 Вимкнення відправки телеметрії для приватності
15:17 Симуляція активності для перевірки стану телеметрії
15:53 Демонстрація, що на сервер телеметрія не надходить
16:13 Зміна API ключа пристрою на сервері та реагування пристрою на це
16:52 Оновлення API ключа пристрою без перепрошивки
17:07 Аналіз логів пристрою після успішного оновленя ключа
17:24 Створення профілю освітлення без локації на сервері
17:44 Зміна профілю пристрою на сервері
17:50 Оновлення розкладу на пристрої
18:11 Пояснення нового профілю освітлення та розкладу освітлення
18:41 Тестування нового розкладу освітлення на пристрої
19:41 Перевірка автономності пристрою
20:40 Підсумки
                                                                                  18
                                    ДОДАТОК Б
                                  Файл compose.yml

     Посилання     на   GitHub:     https://github.com/NureBilousAnton/ark-pzpi-23-3-bilous-anton/blob/main/Lab5/ark-pzpi-23-3-bilous-anton-lab5/compose.yml

 1 services:
 2   database:
 3     image: postgres:18
 4     restart: unless-stopped
 5     ports:
 6        - 5432:5432
 7     volumes:
 8        - data:/var/lib/postgresql/
 9     environment:
10        POSTGRES_DB: data
11        POSTGRES_PASSWORD: password
12        PGDATA: /var/lib/postgresql/pgdata
13
14   app:
15     image: rustlang/rust:nightly
16     ports:
17        - 3000:3000
18     environment:
19        DATABASE_URL: postgres://postgres:password@database:5432/data
20        JWT_SECRET_FILE: /run/secrets/jwt
21        CARGO_TARGET_DIR: ../docker-target
22        BIND_ADDRESS: "0.0.0.0:3000"
23        SQLX_OFFLINE: true
24        RUST_LOG: info
25     working_dir: /app
26     volumes:
27        - .:/app:ro
28        - cargo-cache:/usr/local/cargo/registry
29        - build-output:/docker-target
30        - secrets:/run/secrets
31     command: >
32        sh -c '
33          if [ ! -f "$$JWT_SECRET_FILE" ]; then
34            openssl rand -base64 32 > "$$JWT_SECRET_FILE"
35          fi &&
36          export JWT_SECRET=$$(cat "$$JWT_SECRET_FILE") &&
37          cargo run --release
38        '
39     depends_on:
40        - database
41
42 volumes:
43   data:
44   secrets:
45   cargo-cache:
46   build-output:
                                                                                   19
                                     ДОДАТОК В
                         Код налаштувань IoT клієнта (config.h)

      Посилання     на     GitHub:   https://github.com/NureBilousAnton/ark-pzpi-23-3-bilous-anton/blob/main/Lab5/ark-pzpi-23-3-bilous-anton-lab5/iot/src/config.h

 1   // Device Configuration
 2   #ifndef LUMIRUM_CONFIG_H
 3   #define LUMIRUM_CONFIG_H
 4   #include <Arduino.h> // for time_t type
 5
 6   // WiFi Credentials
 7   // WARNING: the " must stay intact
 8   #define WIFI_SSID "Wokwi-GUEST"
 9   #define WIFI_PASSWORD ""
10
11   // Network & API Configuration
12   #define API_BASE_URL "http://192.168.18.103:3000"
13   #define API_FETCH_ROUTE "/devices/circadian"
14   #define API_TELEMETRY_ROUTE "/telemetry"
15   #define API_KEY_HEADER "x-api-key"
16
17   const int API_KEY_LENGTH = 64; // chars
18   #define API_DEVICE_KEY
     "yRPMOjyC61pISjOnNfUZRBU4hTpQMgJXX666xoFTpyMe3idDOpXqRx20pPewQTIM"
19   const bool TELEMETRY = true; // Whether to send telemetry to the API
20
21   const int MAX_WIFI_ATTEMPTS = 20;
22   const int WIFI_RETRY_DELAY_MS = 500; // 0.5 seconds between connection
     attempts
23   const int WEB_SERVER_PORT = 80;
24
25   const int API_MAX_SCHEDULE_SIZE = 96; // elements
26   const int API_MIN_TEMP_CONSTRAINT_K = 1800; // Minimum allowed by API
27
28   // Pin configuration
29   const int PIN_BUTTON = 3;
30   const int PIN_LED_RING = 8;
31   const int PIN_PIR_SENSOR = 1;
32   const int PIN_POTENTIOMETER = 0;
33
34   // Hardware configuration
35   const int LED_COUNT = 16;
36   const int ANALOG_MAX_VALUE = 4095; // ESP32-C3 ADC resolution is 12-bit
37   const int PWM_MAX_VALUE = 255;     // Standard 8-bit PWM limit
38
39   // Timing configuration
40   const unsigned long LOOP_DELAY_MS = 50;   // 20Hz refresh rate
41   const unsigned long BUTTON_DEBOUNCE_MS = 200; // 0.2 seconds is enough
     for a button press
42   const unsigned long SCHEDULE_REFRESH_INTERVAL_MS = 3600000; // 1 hour
                                                                            20

43   const unsigned long TELEMETRY_DEBOUNCE_MS = 2000; // 2 seconds min
     between sending telemetry events
44   const unsigned long TIME_JUMP_REFETCH_THRESHOLD_SEC =
45       3600; // 1 hour change triggers schedule refetch
46
47   // Color temperature limits (Kelvin)
48   const int MIN_COLOR_TEMP_K = 1000;     // Candlelight/Deep Red
49   const int DEFAULT_COLOR_TEMP_K = 3500; // Warm White
50
51   // Brightness thresholds (0-100%)
52   const int DEFAULT_BRIGHTNESS_LIMIT_PERCENT = 50; // Safety limit for
     startup
53   const int BRIGHTNESS_OFF_THRESHOLD_PERCENT = 10; // Below this, lights
     turn off
54   const int BRIGHTNESS_CHANGE_THRESHOLD_PERCENT = 5; // Hysteresis to
     prevent flickering
55
56
57   #endif // LUMIRUM_CONFIG_H

